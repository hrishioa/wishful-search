/*! For license information please see wishful-search.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.WishfulSearch=t():e.WishfulSearch=t()}(self,(()=>{return e={455:function(e){var t;"undefined"!=typeof self&&self,t=function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=7)}([function(e,t,n){"use strict";n.d(t,"j",(function(){return o})),n.d(t,"d",(function(){return s})),n.d(t,"c",(function(){return i})),n.d(t,"h",(function(){return c})),n.d(t,"b",(function(){return a})),n.d(t,"k",(function(){return l})),n.d(t,"e",(function(){return u})),n.d(t,"g",(function(){return d})),n.d(t,"i",(function(){return f})),n.d(t,"a",(function(){return h})),n.d(t,"f",(function(){return p}));var r=n(1),o=l((function(e,t){var n=t.length;return l((function(r){for(var o=0;o<r.length;o++)t[n+o]=r[o];return t.length=n+r.length,e.apply(this,t)}))}));function s(e,t){return function(){return e.call(this,t.apply(this,arguments))}}function i(e){return function(t){return t[e]}}l((function(e){var t=Object(r.c)(e);function n(e,t){return[a(e,t)]}return l((function(e){return Object(r.f)(n,e,t)[0]}))}));var c=l((function(e){return l((function(t){for(var n,r=0;r<i("length")(e);r++)if(n=a(t,e[r]))return n}))}));function a(e,t){return t.apply(void 0,e)}function l(e){var t=e.length-1,n=Array.prototype.slice;if(0===t)return function(){return e.call(this,n.call(arguments))};if(1===t)return function(){return e.call(this,arguments[0],n.call(arguments,1))};var r=Array(e.length);return function(){for(var o=0;o<t;o++)r[o]=arguments[o];return r[t]=n.call(arguments,t),e.apply(this,r)}}function u(e){return function(t,n){return e(n,t)}}function d(e,t){return function(n){return e(n)&&t(n)}}function f(){}function h(){return!0}function p(e){return function(){return e}}},function(e,t,n){"use strict";n.d(t,"d",(function(){return o})),n.d(t,"g",(function(){return i})),n.d(t,"l",(function(){return c})),n.d(t,"c",(function(){return a})),n.d(t,"h",(function(){return l})),n.d(t,"i",(function(){return u})),n.d(t,"j",(function(){return d})),n.d(t,"f",(function(){return f})),n.d(t,"m",(function(){return h})),n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return y})),n.d(t,"k",(function(){return m})),n.d(t,"e",(function(){return g}));var r=n(0);function o(e,t){return[e,t]}var s=null,i=Object(r.c)(0),c=Object(r.c)(1);function a(e){return m(e.reduce(Object(r.e)(o),s))}var l=Object(r.k)(a);function u(e){return f((function(e,t){return e.unshift(t),e}),[],e)}function d(e,t){return t?o(e(i(t)),d(e,c(t))):s}function f(e,t,n){return n?e(f(e,t,c(n)),i(n)):t}function h(e,t,n){return function e(n,r){return n?t(i(n))?(r(i(n)),c(n)):o(i(n),e(c(n),r)):s}(e,n||r.i)}function p(e,t){return!t||e(i(t))&&p(e,c(t))}function y(e,t){e&&(i(e).apply(null,t),y(c(e),t))}function m(e){return function e(t,n){return t?e(c(t),o(i(t),n)):n}(e,s)}function g(e,t){return t&&(e(i(t))?i(t):g(e,c(t)))}},function(e,t,n){"use strict";n.d(t,"c",(function(){return s})),n.d(t,"e",(function(){return i})),n.d(t,"d",(function(){return c})),n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return l}));var r=n(1),o=n(0);function s(e,t){return t&&t.constructor===e}var i=Object(o.c)("length"),c=Object(o.j)(s,String);function a(e){return void 0!==e}function l(e,t){return t instanceof Object&&Object(r.a)((function(e){return e in t}),e)}},function(e,t,n){"use strict";n.d(t,"f",(function(){return o})),n.d(t,"d",(function(){return s})),n.d(t,"g",(function(){return i})),n.d(t,"e",(function(){return c})),n.d(t,"b",(function(){return a})),n.d(t,"h",(function(){return l})),n.d(t,"i",(function(){return u})),n.d(t,"c",(function(){return d})),n.d(t,"m",(function(){return f})),n.d(t,"n",(function(){return h})),n.d(t,"a",(function(){return p})),n.d(t,"j",(function(){return y})),n.d(t,"l",(function(){return m})),n.d(t,"k",(function(){return g})),n.d(t,"o",(function(){return v}));var r=1,o=r++,s=r++,i=r++,c=r++,a="fail",l=r++,u=r++,d="start",f="data",h="end",p=r++,y=r++,m=r++,g=r++;function v(e,t,n){try{var r=JSON.parse(t)}catch(e){}return{statusCode:e,body:t,jsonBody:r,thrown:n}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return i}));var r=n(0);function o(e,t){return{key:e,node:t}}var s=Object(r.c)("key"),i=Object(r.c)("node")},function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var r=n(1),o=n(0),s=n(2),i=n(8),c=n(9);function a(e){var t=Object(r.h)("resume","pause","pipe"),n=Object(o.j)(s.b,t);return e?n(e)||Object(s.d)(e)?Object(i.a)(c.a,e):Object(i.a)(c.a,e.url,e.method,e.body,e.headers,e.withCredentials,e.cached):Object(c.a)()}a.drop=function(){return a.drop}},function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return c}));var r=n(3),o=n(4),s=n(2),i=n(1),c={};function a(e){var t=e(r.f).emit,n=e(r.d).emit,a=e(r.i).emit,l=e(r.h).emit;function u(e,t,n){Object(o.c)(Object(i.g)(e))[t]=n}function d(e,n,r){e&&u(e,n,r);var s=Object(i.d)(Object(o.b)(n,r),e);return t(s),s}var f={};return f[r.l]=function(e,t){if(!e)return a(t),d(e,c,t);var n=function(e,t){var n=Object(o.c)(Object(i.g)(e));return Object(s.c)(Array,n)?d(e,Object(s.e)(n),t):e}(e,t),r=Object(i.l)(n),l=Object(o.a)(Object(i.g)(n));return u(r,l,t),Object(i.d)(Object(o.b)(l,t),r)},f[r.k]=function(e){return n(e),Object(i.l)(e)||l(Object(o.c)(Object(i.g)(e)))},f[r.j]=d,f}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(5);t.default=r.a},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var r=n(2);function o(e,t,n,o,s,i,c){return s=s?JSON.parse(JSON.stringify(s)):{},o?(Object(r.d)(o)||(o=JSON.stringify(o),s["Content-Type"]=s["Content-Type"]||"application/json"),s["Content-Length"]=s["Content-Length"]||o.length):o=null,e(n||"GET",function(e,t){return!1===t&&(-1===e.indexOf("?")?e+="?":e+="&",e+="_="+(new Date).getTime()),e}(t,c),o,s,i||!1)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var r=n(10),o=n(12),s=n(6),i=n(13),c=n(14),a=n(16),l=n(17),u=n(18);function d(e,t,n,d,f){var h=Object(r.a)();return t&&Object(u.b)(h,Object(u.a)(),e,t,n,d,f),Object(l.a)(h),Object(o.a)(h,Object(s.b)(h)),Object(i.a)(h,c.a),Object(a.a)(h,t)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var r=n(11),o=n(0);function s(){var e={},t=s("newListener"),n=s("removeListener");function s(o){return e[o]=Object(r.a)(o,t,n),e[o]}function i(t){return e[t]||s(t)}return["emit","on","un"].forEach((function(e){i[e]=Object(o.k)((function(t,n){Object(o.b)(n,i(t)[e])}))})),i}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n(1),o=n(2),s=n(0);function i(e,t,n){var i,c;function a(e){return function(t){return t.id===e}}return{on:function(n,o){var s={listener:n,id:o||n};return t&&t.emit(e,n,s.id),i=Object(r.d)(s,i),c=Object(r.d)(n,c),this},emit:function(){Object(r.b)(c,arguments)},un:function(t){var o;i=Object(r.m)(i,a(t),(function(e){o=e})),o&&(c=Object(r.m)(c,(function(e){return e===o.listener})),n&&n.emit(e,o.listener,o.id))},listeners:function(){return c},hasListener:function(e){var t=e?a(e):s.a;return Object(o.a)(Object(r.e)(t,i))}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n(4),o=n(3),s=n(1);function i(e,t){var n,i={};function c(e){return function(t){n=e(n,t)}}for(var a in t)e(a).on(c(t[a]),i);e(o.g).on((function(e){var t=Object(s.g)(n),o=Object(r.a)(t),i=Object(s.l)(n);i&&(Object(r.c)(Object(s.g)(i))[o]=e)})),e(o.e).on((function(){var e=Object(s.g)(n),t=Object(r.a)(e),o=Object(s.l)(n);o&&delete Object(r.c)(Object(s.g)(o))[t]})),e(o.a).on((function(){for(var n in t)e(n).un(i)}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n(3),o=n(1),s=n(4);function i(e,t){var n={node:e(r.d),path:e(r.f)};e("newListener").on((function(r){var i=/(node|path):(.*)/.exec(r);if(i){var c=n[i[1]];c.hasListener(r)||function(t,n,r){var i=e(t).emit;n.on((function(e){var t=r(e);!1!==t&&function(e,t,n){var r=Object(o.k)(n);e(t,Object(o.i)(Object(o.l)(Object(o.j)(s.a,r))),Object(o.i)(Object(o.j)(s.c,r)))}(i,Object(s.c)(t),e)}),t),e("removeListener").on((function(r){r===t&&(e(r).listeners()||n.un(t))}))}(r,c,t(i[2]))}}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var r=n(0),o=n(1),s=n(4),i=n(2),c=n(6),a=n(15),l=Object(a.a)((function(e,t,n,a,l){var u=Object(r.d)(s.a,o.g),d=Object(r.d)(s.c,o.g);function f(e,t){return t[1]?Object(r.g)(e,o.g):e}function h(e){return e===r.a?r.a:Object(r.g)((function(e){return u(e)!==c.a}),Object(r.d)(e,o.l))}function p(){return function(e){return u(e)===c.a}}function y(e,t,n,r,s){var c=e(n);if(c){var a=function(e,t,n){return Object(o.f)((function(e,t){return t(e,n)}),t,e)}(t,r,c);return s(n.substr(Object(i.e)(c[0])),a)}}function m(e,t){return Object(r.j)(y,e,t)}var g=Object(r.h)(m(e,Object(o.h)(f,(function(e,t){var n=t[3];if(!n)return e;var s=Object(r.j)(i.b,Object(o.c)(n.split(/\W+/))),c=Object(r.d)(s,d);return Object(r.g)(c,e)}),(function(e,t){var n=t[2],o=n&&"*"!==n?function(e){return String(u(e))===n}:r.a;return Object(r.g)(o,e)}),h)),m(t,Object(o.h)((function(e){if(e===r.a)return r.a;var t=p(),n=e,o=h((function(e){return s(e)})),s=Object(r.h)(t,n,o);return s}))),m(n,Object(o.h)()),m(a,Object(o.h)(f,p)),m(l,Object(o.h)((function(e){return function(t){var n=e(t);return!0===n?Object(o.g)(t):n}}))),(function(e){throw Error('"'+e+'" could not be tokenised')}));function v(e,t){return t}function b(e,t){return g(e,t,e?b:v)}return function(e){try{return b(e,r.a)}catch(t){throw Error('Could not compile "'+e+'" because '+t.message)}}}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return y}));var r,o,s,i,c,a,l,u,d,f,h,p=n(0),y=(r=Object(p.k)((function(e){return e.unshift(/^/),(t=RegExp(e.map(Object(p.c)("source")).join(""))).exec.bind(t);var t})),i=r(o=/(\$?)/,/([\w-_]+|\*)/,s=/(?:{([\w ]*?)})?/),c=r(o,/\["([^"]+)"\]/,s),a=r(o,/\[(\d+|\*)\]/,s),l=r(o,/()/,/{([\w ]*?)}/),u=r(/\.\./),d=r(/\./),f=r(o,/!/),h=r(/$/),function(e){return e(Object(p.h)(i,c,a,l),u,d,f,h)})},function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var r=n(3),o=n(0),s=n(2),i=n(5);function c(e,t){var n,c=/^(node|path):./,a=e(r.h),l=e(r.e).emit,u=e(r.g).emit,d=Object(o.k)((function(t,r){if(n[t])Object(o.b)(r,n[t]);else{var s=e(t),i=r[0];c.test(t)?f(s,p(i)):s.on(i)}return n}));function f(e,t,r){r=r||t;var s=h(t);return e.on((function(){var t=!1;n.forget=function(){t=!0},Object(o.b)(arguments,s),delete n.forget,t&&e.un(r)}),r),n}function h(e){return function(){try{return e.apply(n,arguments)}catch(e){setTimeout((function(){throw new Error(e.message)}))}}}function p(e){return function(){var t=e.apply(this,arguments);Object(s.a)(t)&&(t===i.a.drop?l():u(t))}}function y(t,n,r){var o;o="node"===t?p(r):r,f(function(t,n){return e(t+":"+n)}(t,n),o,r)}function m(e,t,r){return Object(s.d)(t)?y(e,t,r):function(e,t){for(var n in t)y(e,n,t[n])}(e,t),n}return e(r.i).on((function(e){n.root=Object(o.f)(e)})),e(r.c).on((function(e,t){n.header=function(e){return e?t[e]:t}})),n={on:d,addListener:d,removeListener:function(t,r,o){if("done"===t)a.un(r);else if("node"===t||"path"===t)e.un(t+":"+r,o);else{var s=r;e(t).un(s)}return n},emit:e.emit,node:Object(o.j)(m,"node"),path:Object(o.j)(m,"path"),done:Object(o.j)(f,a),start:Object(o.j)((function(t,r){return e(t).on(h(r),r),n}),r.c),fail:e(r.b).on,abort:e(r.a).emit,header:o.i,root:o.i,source:t}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var r=n(3);function o(e){var t,n,o,s,i=e(r.j).emit,c=e(r.l).emit,a=e(r.k).emit,l=e(r.b).emit,u=65536,d=/[\\"\n]/g,f=0,h=f++,p=f++,y=f++,m=f++,g=f++,v=f++,b=f++,S=f++,O=f++,w=f++,N=f++,_=f++,T=f++,E=f++,j=f++,L=f++,I=f++,A=f++,R=f++,x=f++,P=u,M="",$=!1,D=!1,k=h,C=[],W=null,Q=0,q=0,J=0,F=0,U=1;function H(e){void 0!==s&&(c(s),a(),s=void 0),t=Error(e+"\nLn: "+U+"\nCol: "+F+"\nChr: "+n),l(Object(r.o)(void 0,void 0,t))}function K(e){return"\r"===e||"\n"===e||" "===e||"\t"===e}e(r.m).on((function(e){if(!t){if(D)return H("Cannot write after close");var r,l=0;for(n=e[0];n&&(l>0&&(o=n),n=e[l++]);)switch(J++,"\n"===n?(U++,F=0):F++,k){case h:if("{"===n)k=y;else if("["===n)k=g;else if(!K(n))return H("Non-whitespace before {[.");continue;case S:case y:if(K(n))continue;if(k===S)C.push(O);else{if("}"===n){c({}),a(),k=C.pop()||p;continue}C.push(m)}if('"'!==n)return H('Malformed object key should start with " ');k=b;continue;case O:case m:if(K(n))continue;if(":"===n)k===m?(C.push(m),void 0!==s&&(c({}),i(s),s=void 0),q++):void 0!==s&&(i(s),s=void 0),k=p;else if("}"===n)void 0!==s&&(c(s),a(),s=void 0),a(),q--,k=C.pop()||p;else{if(","!==n)return H("Bad object");k===m&&C.push(m),void 0!==s&&(c(s),a(),s=void 0),k=S}continue;case g:case p:if(K(n))continue;if(k===g){if(c([]),q++,k=p,"]"===n){a(),q--,k=C.pop()||p;continue}C.push(v)}if('"'===n)k=b;else if("{"===n)k=y;else if("["===n)k=g;else if("t"===n)k=w;else if("f"===n)k=T;else if("n"===n)k=I;else if("-"===n)M+=n;else if("0"===n)M+=n,k=20;else{if(-1==="123456789".indexOf(n))return H("Bad value");M+=n,k=20}continue;case v:if(","===n)C.push(v),void 0!==s&&(c(s),a(),s=void 0),k=p;else{if("]"!==n){if(K(n))continue;return H("Bad array")}void 0!==s&&(c(s),a(),s=void 0),a(),q--,k=C.pop()||p}continue;case b:void 0===s&&(s="");var f=l-1;e:for(;;){for(;Q>0;)if(W+=n,n=e.charAt(l++),4===Q?(s+=String.fromCharCode(parseInt(W,16)),Q=0,f=l-1):Q++,!n)break e;if('"'===n&&!$){k=C.pop()||p,s+=e.substring(f,l-1);break}if(!("\\"!==n||$||($=!0,s+=e.substring(f,l-1),n=e.charAt(l++))))break;if($){if($=!1,"n"===n?s+="\n":"r"===n?s+="\r":"t"===n?s+="\t":"f"===n?s+="\f":"b"===n?s+="\b":"u"===n?(Q=1,W=""):s+=n,n=e.charAt(l++),f=l-1,n)continue;break}d.lastIndex=l;var B=d.exec(e);if(!B){l=e.length+1,s+=e.substring(f,l-1);break}if(l=B.index+1,!(n=e.charAt(B.index))){s+=e.substring(f,l-1);break}}continue;case w:if(!n)continue;if("r"!==n)return H("Invalid true started with t"+n);k=N;continue;case N:if(!n)continue;if("u"!==n)return H("Invalid true started with tr"+n);k=_;continue;case _:if(!n)continue;if("e"!==n)return H("Invalid true started with tru"+n);c(!0),a(),k=C.pop()||p;continue;case T:if(!n)continue;if("a"!==n)return H("Invalid false started with f"+n);k=E;continue;case E:if(!n)continue;if("l"!==n)return H("Invalid false started with fa"+n);k=j;continue;case j:if(!n)continue;if("s"!==n)return H("Invalid false started with fal"+n);k=L;continue;case L:if(!n)continue;if("e"!==n)return H("Invalid false started with fals"+n);c(!1),a(),k=C.pop()||p;continue;case I:if(!n)continue;if("u"!==n)return H("Invalid null started with n"+n);k=A;continue;case A:if(!n)continue;if("l"!==n)return H("Invalid null started with nu"+n);k=R;continue;case R:if(!n)continue;if("l"!==n)return H("Invalid null started with nul"+n);c(null),a(),k=C.pop()||p;continue;case x:if("."!==n)return H("Leading zero not followed by .");M+=n,k=20;continue;case 20:if(-1!=="0123456789".indexOf(n))M+=n;else if("."===n){if(-1!==M.indexOf("."))return H("Invalid number has two dots");M+=n}else if("e"===n||"E"===n){if(-1!==M.indexOf("e")||-1!==M.indexOf("E"))return H("Invalid number has two exponential");M+=n}else if("+"===n||"-"===n){if("e"!==o&&"E"!==o)return H("Invalid symbol in number");M+=n}else M&&(c(parseFloat(M)),a(),M=""),l--,k=C.pop()||p;continue;default:return H("Unknown state: "+k)}J>=P&&(r=0,void 0!==s&&s.length>u&&(H("Max buffer length exceeded: textNode"),r=Math.max(r,s.length)),M.length>u&&(H("Max buffer length exceeded: numberNode"),r=Math.max(r,M.length)),P=u-r+J)}})),e(r.n).on((function(){if(k===h)return c({}),a(),void(D=!0);k===p&&0===q||H("Unexpected end"),void 0!==s&&(c(s),a(),s=void 0),D=!0}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return l}));var r=n(19),o=n(3),s=n(2),i=n(20),c=n(0);function a(){return new XMLHttpRequest}function l(e,t,n,a,l,u,d){var f=e(o.m).emit,h=e(o.b).emit,p=0,y=!0;function m(){if("2"===String(t.status)[0]){var e=t.responseText,n=(" "+e.substr(p)).substr(1);n&&f(n),p=Object(s.e)(e)}}function g(t){try{y&&e(o.c).emit(t.status,Object(i.a)(t.getAllResponseHeaders())),y=!1}catch(e){}}e(o.a).on((function(){t.onreadystatechange=null,t.abort()})),"onprogress"in t&&(t.onprogress=m),t.onreadystatechange=function(){switch(t.readyState){case 2:case 3:return g(t);case 4:g(t),"2"===String(t.status)[0]?(m(),e(o.n).emit()):h(Object(o.o)(t.status,t.responseText))}};try{for(var v in t.open(n,a,!0),u)t.setRequestHeader(v,u[v]);Object(r.a)(window.location,Object(r.b)(a))||t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.withCredentials=d,t.send(l)}catch(e){window.setTimeout(Object(c.j)(h,Object(o.o)(void 0,void 0,e)),0)}}},function(e,t,n){"use strict";function r(e,t){function n(t){return String(t.port||{"http:":80,"https:":443}[t.protocol||e.protocol])}return!!(t.protocol&&t.protocol!==e.protocol||t.host&&t.host!==e.host||t.host&&n(t)!==n(e))}function o(e){var t=/(\w+:)?(?:\/\/)([\w.-]+)?(?::(\d+))?\/?/.exec(e)||[];return{protocol:t[1]||"",host:t[2]||"",port:t[3]||""}}n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return o}))},function(e,t,n){"use strict";function r(e){var t={};return e&&e.split("\r\n").forEach((function(e){var n=e.indexOf(": ");t[e.substring(0,n)]=e.substring(n+2)})),t}n.d(t,"a",(function(){return r}))}]).default},e.exports=t()},99:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.paginateRawResults=t.detectType=t.addColumnTypes=void 0;const r=n(683);function o(e,t){const n=e.map((e=>e.columns.filter((e=>!!e.statsColumnType)))).flat().find((e=>e.name===t));if(n)return n.statsColumnType;const o=r.VALID_PRIMITIVE_TYPES.find((e=>t.toLowerCase().startsWith(e)));return o?{type:o}:t.toLowerCase().startsWith("currency")?{type:"currency",code:t.slice(8,11).toUpperCase()}:{type:"unknown"}}t.addColumnTypes=function(e,t){return e&&e.rawResults&&e.rawResults.length&&(e.rawResults=e.rawResults.map((e=>(e.columns&&e.columns.length&&(e.columnTypes=e.columns.map((e=>o(t,e)))),e)))),e},t.detectType=o,t.paginateRawResults=function(e,t=200,n=1){return e.map((e=>{const r=(n-1)*t,o=Math.min(e.values.length,r+t);return{columns:e.columns,columnTypes:e.columnTypes,values:e.values.slice(r,o),rowsPerPage:t,page:n,totalRows:e.values.length}}))}},173:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateAutoSearchMessages=void 0;const r=n(683),o=(e,t)=>`The user had this USER_QUESTION: ${e}\n\nWe tried the following modified questions, and got these queries and results:\n\n${t.map(((e,t)=>` - ${t+1}: "${e.question}" generated "${e.query}" which returned ${e.results.count} results with top prettified result "${e.results.topResultStr}". ${e.suitabilityDesc?`Suitability was ${e.suitabilityScore} (${e.suitabilityDesc}`:""}`)).join("\n")}\n\nWe can improve the results by looking for ways to increase suitability. Check for patterns (like consistent no resutls, same result over again, etc). Return your analysis following this typespec, and be exhaustive and thorough.\n\n'''typescript\n${r.AnalysisTypespec}\n\`\`\`\n\nValid JSON:`;t.generateAutoSearchMessages=function(e,t,n){return[{content:(r=e,`You can only return valid JSON.\n\nInformation is stored in tables with this schema:\n\`\`\`\n${r}\n\`\`\``),role:"system"},{content:o(t,n),role:"user"}];var r}},509:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{a(r.next(e))}catch(e){s(e)}}function c(e){try{a(r.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}a((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LLMSearcheableDatabase=void 0;const s=o(n(470));class i{static create(e,t,n,o,c){return r(this,void 0,void 0,(function*(){const r={locateFile:c?()=>c:void 0},a=yield(0,s.default)(r),l=new a.Database;return l.run(e),new i(l,a,e,t,n,o)}))}constructor(e,t,n,r,o,s){if(this.sqljsSQL=t,this.strDDL=n,this.dbname=r,this.key=o,this.objectToTabledRow=s,this.db=e,this.tableNames=this.getTableNames(),!this.tableNames.includes(o.table))throw new Error(`Primary table ${o.table} not found in database`);this.tableNames=[o.table,...this.tableNames.filter((e=>e!==o.table))]}getTableNames(){const e=this.db.exec('SELECT name FROM sqlite_master WHERE type="table"');if(!e||!e.length||!e[0])throw new Error("No tables found in database");return e[0].values.flat()}getEnums(e,t=!1){const n=t?`SELECT ${e.column}, COUNT(${e.column}) as frequency\n    FROM ${e.table}\n    GROUP BY ${e.column}\n    ORDER BY frequency DESC;`:`SELECT DISTINCT ${e.column} FROM ${e.table}`,r=this.db.exec(n);return r.length&&r[0]?t?r[0].values.map((e=>e[0])):r[0].values.flat():[]}rawQuery(e){const t=["INSERT","UPDATE","DELETE","CREATE","ALTER","DROP","PRAGMA","BEGIN","COMMIT","ROLLBACK","REPLACE"];e=e.split(";")[0].trim();for(const n of t)if(e.toUpperCase().includes(n))throw new Error(`Query must not have ${n}`);if(!e.toUpperCase().startsWith("SELECT"))throw new Error("Raw Query to db must start with SELECT");if(-1!==e.indexOf(";"))throw new Error("Raw Query to db must be a single statement");const n=this.db.exec(e);return n.length&&n[0]?n[0].values.flat():[]}complexQuery(e){if(!(e=e.split(";")[0].trim()).toUpperCase().startsWith("SELECT"))throw new Error("Raw Query to db must start with SELECT");if(-1!==e.indexOf(";"))throw new Error("Raw Query to db must be a single statement");const t=this.db.exec(e);return t.length&&t[0]?t:[]}getColumnCount(e){const t=this.db.exec(`SELECT COUNT(*) FROM pragma_table_info('${e}')`);if(!t||!t.length||!t[0])throw new Error("Tried to get columns on invalid db");return t[0].values[0][0]}delete(e){const t=e.map((e=>"?")).join(","),n=`DELETE FROM ${this.key.table} WHERE ${this.key.column} IN (${t})`;this.db.run(n,e)}insert(e,t=!1){const n=e.map((e=>this.objectToTabledRow(e))),r=n.filter((e=>e.length===this.tableNames.length));if(r.length!==n.length&&t)throw new Error(n.length-r.length+" rows do not match the number of columns in the table.");const o=[];for(const e of n)for(let n=0;n<this.tableNames.length;n++){const r=this.tableNames[n],s=this.getColumnCount(r),i=`INSERT OR IGNORE INTO ${r} VALUES (${Array(s).fill("?").join(",")})`,c=this.db.prepare(i);try{this.db.run("BEGIN"),e[n].forEach((e=>{try{c.bind(e),c.step()}catch(r){if(t)throw new Error(`Error running "${i}" inserting row ${JSON.stringify(e,null,2)} - ${r}`);o.push({index:n,error:r})}})),this.db.run("COMMIT")}catch(t){throw"yes"===process.env.PRINT_WS_INTERNALS&&console.log("Error inserting in table ",r,", row",JSON.stringify(e,null,2),t),this.db.run("ROLLBACK"),t}}return o}clearDb(){this.db.close(),this.db=new this.sqljsSQL.Database,this.db.run(this.strDDL)}}t.LLMSearcheableDatabase=i},54:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LLMAdapters=t.WishfulSearchEngine=void 0;var i=n(322);Object.defineProperty(t,"WishfulSearchEngine",{enumerable:!0,get:function(){return i.WishfulSearchEngine}});var c=n(738);Object.defineProperty(t,"LLMAdapters",{enumerable:!0,get:function(){return s(c).default}}),o(n(683),t)},842:function(e,t){"use strict";var n=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{a(r.next(e))}catch(e){s(e)}}function c(e){try{a(r.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}a((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.fixJSON=void 0;const r="You can only return valid JSON.",o=(e,t)=>`\nError: ${e}\n\nFix this invalid JSON and return perfectly valid JSON without changing any content:\n\n'''json\n${t}\n'''\n`,s=[{invalidJSONStr:'type Analysis = {\n  suitabilityDesc: "The top result included a layover which does not match a direct flight.",\n  suitability: 0.3,\n  desires: ["A non-stop flight", "No layovers"],\n}',error:"Uncaught SyntaxError: Unexpected token 'y', \"type Analys\"... is not valid JSON",fixedJSONStr:'{\n  "suitabilityDesc": "The top result included a layover which does not match a direct flight.",\n  "suitability": 0.3,\n  "desires": ["A non-stop flight", "No layovers"],\n}'},{invalidJSONStr:"{abc:2}",error:"Uncaught SyntaxError: Expected property name or '}' in JSON at position 1",fixedJSONStr:'{"abc":2}'}];t.fixJSON=function(e,t){return n(this,void 0,void 0,(function*(){try{return JSON.parse(t)}catch(n){const i=[{content:r,role:"system"}];for(const e of s)i.push({content:o(e.error,e.invalidJSONStr),role:"user"}),i.push({role:"assistant",content:e.fixedJSONStr});i.push({role:"user",content:o(n.toString(),t)});const c=yield e(i);return c?JSON.parse(c):null}}))}},738:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{a(r.next(e))}catch(e){s(e)}}function c(e){try{a(r.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}a((r=r.apply(e,t||[])).next())}))},o=this&&this.__asyncValues||function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,o){!function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)}(r,o,(t=e[n](t)).done,t.value)}))}}},s=this&&this.__rest||function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n};Object.defineProperty(t,"__esModule",{value:!0}),t.getGroqAdapter=t.getAzureOpenAIAdapter=t.getAzureMistralAdapter=t.getOpenAIAdapter=t.getLMStudioAdapter=t.getClaudeAdapter=t.getClaudeLegacyAdapter=t.getOllamaAdapter=t.getTogetherAIAdapter=void 0;const i=n(934),c=n(141),a=n(501),l=n(275);function u(e){const t="mistralai/Mixtral-8x7B-Instruct-v0.1";return{llmConfig:{enableTodaysDate:!0,fewShotLearning:[]},callLLM:function(n,s){var i,c,l,u,d,f,h,p;return r(this,void 0,void 0,(function*(){s&&"assistant"!==n[n.length-1].role&&n.push({role:"assistant",content:s}),"yes"===process.env.PRINT_WS_INTERNALS&&console.log(`Asking ${null!==(d=null==e?void 0:e.model)&&void 0!==d?d:t} on TogetherAI...`);const r=yield(0,a.callTogetherAI)(n,null!==(f=null==e?void 0:e.model)&&void 0!==f?f:t,null!==(h=null==e?void 0:e.temperature)&&void 0!==h?h:.5,null!==(p=null==e?void 0:e.max_tokens)&&void 0!==p?p:1e4);"yes"===process.env.PRINT_WS_INTERNALS&&console.log("Streaming response: ");const y=process.hrtime();let m=0;try{for(var g,v=!0,b=o(r);g=yield b.next(),!(i=g.done);v=!0){u=g.value,v=!1;const e=u;if("token"===e.type&&("yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write(e.token),m+=e.token.length),"error"===e.type&&"yes"===process.env.PRINT_WS_INTERNALS&&console.error(e.error),"completeMessage"===e.type){const t=process.hrtime(y);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",m/(t[0]+t[1]/1e9)),e.message}}}catch(e){c={error:e}}finally{try{v||i||!(l=b.return)||(yield l.call(b))}finally{if(c)throw c.error}}return null}))}}}function d(e){const t="mistral",{response_format:n}=e||{};return{llmConfig:{enableTodaysDate:!0,fewShotLearning:[]},callLLM:function(s,a){var u,d,f,h,p,y,m,g,v,b,S;return r(this,void 0,void 0,(function*(){a&&"assistant"!==s[s.length-1].role&&s.push({role:"assistant",content:a});const{prompt:r,stopSequences:O}=i.LLMTemplateFunctions.mistral(s);"yes"===process.env.PRINT_WS_INTERNALS&&console.log(`Asking ${null!==(v=null==e?void 0:e.model)&&void 0!==v?v:t} on Ollama...`);const w=yield(0,c.callOllama)(r,null!==(b=null==e?void 0:e.model)&&void 0!==b?b:t,{temperature:null!==(S=null==e?void 0:e.temperature)&&void 0!==S?S:0,format:"json_object"===(null==n?void 0:n.type)?"json":void 0});"yes"===process.env.PRINT_WS_INTERNALS&&console.log("Streaming response: ");const N=process.hrtime();let _=0;if("json_object"===(null==n?void 0:n.type)){console.log("JSON stream parser:");const e=(0,l.jsonStreamParser)(w,(e=>"token"===e.type?e.token:""),{includeRaw:!0});try{for(var T,E=!0,j=o(e);T=yield j.next(),!(u=T.done);E=!0){h=T.value,E=!1;const e=h;if("token"===e.type)"yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write(e.token),_+=e.token.length;else if("completeJSON"===e.type)return e.completeJSON}}catch(e){d={error:e}}finally{try{E||u||!(f=j.return)||(yield f.call(j))}finally{if(d)throw d.error}}const t=process.hrtime(N);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",_/(t[0]+t[1]/1e9)),null}{try{for(var L,I=!0,A=o(w);L=yield A.next(),!(p=L.done);I=!0){g=L.value,I=!1;const e=g;if("completeMessage"===e.type)return"yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write(e.message.split(O[0])[0]||"<NO TOKEN RECEIVED>"),_+=e.message.length,e.message.split(O[0])[0]||null}}catch(e){y={error:e}}finally{try{I||p||!(m=A.return)||(yield m.call(A))}finally{if(y)throw y.error}}const e=process.hrtime(N);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",_/(e[0]+e[1]/1e9)),null}}))}}}function f(e,t,n,i){const c={model:"claude-2",temperature:0},a=i||{},{response_format:u}=a,d=s(a,["response_format"]),f={llmConfig:{enableTodaysDate:!0,fewShotLearning:[]},callLLM:function(s,a){var f,h,p,y,m,g,v,b,S;return r(this,void 0,void 0,(function*(){let r=s.map((n=>"user"===n.role?`${e} ${n.content}`:"assistant"===n.role?`${t} ${n.content}`:`${e} <system>${n.content}</system>`)).join("");"assistant"!==s[s.length-1].role&&(r+=`${t}${a?` ${a}`:""}`);try{"yes"===process.env.PRINT_WS_INTERNALS&&console.log(`Asking ${null!==(S=null==i?void 0:i.model)&&void 0!==S?S:c.model} (Anthropic)...\n`);const e=yield n.completions.create(Object.assign(Object.assign({prompt:r,max_tokens_to_sample:1e4},Object.assign(Object.assign({},c),d||{})),{stream:!0}));let t="";"yes"===process.env.PRINT_WS_INTERNALS&&console.log("Streaming response: ");const s=process.hrtime();let a=0;if("json_object"===(null==u?void 0:u.type)){console.log("JSON stream parser:");const n=(0,l.jsonStreamParser)(e,(e=>e.completion),{includeRaw:!0});try{for(var O,w=!0,N=o(n);O=yield N.next(),!(f=O.done);w=!0){y=O.value,w=!1;const e=y;"token"===e.type?("yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write(e.token),a+=e.token.length):"completeJSON"===e.type&&(t=e.completeJSON)}}catch(e){h={error:e}}finally{try{w||f||!(p=N.return)||(yield p.call(N))}finally{if(h)throw h.error}}const r=process.hrtime(s);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",a/(r[0]+r[1]/1e9)),t||null}{try{for(var _,T=!0,E=o(e);_=yield E.next(),!(m=_.done);T=!0){b=_.value,T=!1;const e=b;"yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write(e.completion||""),t+=e.completion||"",e.completion&&(a+=e.completion.length)}}catch(e){g={error:e}}finally{try{T||m||!(v=E.return)||(yield v.call(E))}finally{if(g)throw g.error}}const n=process.hrtime(s);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",a/(n[0]+n[1]/1e9)),t||null}}catch(e){return console.error(`Error retrieving response from model ${i}`),console.error(e),null}}))}};return f}function h(e,t){const n={model:"claude-2",temperature:0},i=t||{},{response_format:c}=i,a=s(i,["response_format"]),u={llmConfig:{enableTodaysDate:!0,fewShotLearning:[]},callLLM:function(s){var i,u,d,f,h,p,y,m,g,v;return r(this,void 0,void 0,(function*(){try{const _=s.filter((e=>"system"!==e.role)).map((e=>({role:e.role,content:"assistant"===e.role?e.content.trimEnd():e.content})));"yes"===process.env.PRINT_WS_INTERNALS&&console.log(`Asking ${null!==(g=null==t?void 0:t.model)&&void 0!==g?g:n.model} (Anthropic)...\n`);const T=yield e.messages.create(Object.assign(Object.assign({messages:_,system:null===(v=s.find((e=>"system"===e.role)))||void 0===v?void 0:v.content,max_tokens:4096},Object.assign(Object.assign({},n),a||{})),{stream:!0}));let E="";"yes"===process.env.PRINT_WS_INTERNALS&&console.log("Streaming response: ");const j=process.hrtime();let L=0;if("json_object"===(null==c?void 0:c.type)){console.log("JSON stream parser:");const e=(0,l.jsonStreamParser)(T,(e=>"content_block_start"===e.type?e.content_block.text:"content_block_delta"===e.type?e.delta.text:""),{includeRaw:!0});try{for(var r,b=!0,S=o(e);r=yield S.next(),!(i=r.done);b=!0){f=r.value,b=!1;const e=f;"token"===e.type?("yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write(e.token),L+=e.token.length):"completeJSON"===e.type&&(E=e.completeJSON)}}catch(e){u={error:e}}finally{try{b||i||!(d=S.return)||(yield d.call(S))}finally{if(u)throw u.error}}const t=process.hrtime(j);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",L/(t[0]+t[1]/1e9)),E||null}{try{for(var O,w=!0,N=o(T);O=yield N.next(),!(h=O.done);w=!0){m=O.value,w=!1;const e=m;"content_block_start"===e.type?(E+=e.content_block.text||"","yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write(e.content_block.text||"")):"content_block_delta"===e.type?(E+=e.delta.text||"","yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write(e.delta.text||"")):"message_delta"===e.type&&(L+=e.usage.output_tokens)}}catch(e){p={error:e}}finally{try{w||h||!(y=N.return)||(yield y.call(N))}finally{if(p)throw p.error}}const e=process.hrtime(j);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",L/(e[0]+e[1]/1e9)),E||null}}catch(e){return console.error(`Error retrieving response from model ${t}`),console.error(e),null}}))}};return u}function p(e,t,n){const c={model:"mistral",temperature:0},a=n||{},{response_format:u}=a,d=s(a,["response_format"]),f={llmConfig:{enableTodaysDate:!0,fewShotLearning:[]},callLLM:function(s,a){var f,h,p,y,m,g,v,b,S,O,w,N,_,T,E,j,L;return r(this,void 0,void 0,(function*(){a&&"assistant"!==s[s.length-1].role&&s.push({role:"assistant",content:a});const{prompt:r,stopSequences:I}=i.LLMTemplateFunctions[t](s);try{"yes"===process.env.PRINT_WS_INTERNALS&&console.log(`Asking ${null!==(S=null==n?void 0:n.model)&&void 0!==S?S:c.model} on your machine (LMStudio)...`);const t=yield e.chat.completions.create(Object.assign(Object.assign({messages:[{role:"user",content:r}]},Object.assign(Object.assign({},c),d||{})),{stop:I,stream:!0}));let s="";"yes"===process.env.PRINT_WS_INTERNALS&&console.log("Streaming response: ");const i=process.hrtime();let a=0;if("json_object"===(null==u?void 0:u.type)){console.log("JSON stream parser:");const e=(0,l.jsonStreamParser)(t,(e=>{var t,n;return(null===(n=null===(t=e.choices[0])||void 0===t?void 0:t.delta)||void 0===n?void 0:n.content)||""}),{includeRaw:!0});try{for(var A,R=!0,x=o(e);A=yield x.next(),!(f=A.done);R=!0){y=A.value,R=!1;const e=y;"token"===e.type?("yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write(e.token),a+=e.token.length):"completeJSON"===e.type&&(s=e.completeJSON)}}catch(e){h={error:e}}finally{try{R||f||!(p=x.return)||(yield p.call(x))}finally{if(h)throw h.error}}const n=process.hrtime(i);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",a/(n[0]+n[1]/1e9)),s||null}{try{for(var P,M=!0,$=o(t);P=yield $.next(),!(m=P.done);M=!0){b=P.value,M=!1;const e=b;"yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write((null===(w=null===(O=e.choices[0])||void 0===O?void 0:O.delta)||void 0===w?void 0:w.content)||""),s+=(null===(_=null===(N=e.choices[0])||void 0===N?void 0:N.delta)||void 0===_?void 0:_.content)||"",(null===(E=null===(T=e.choices[0])||void 0===T?void 0:T.delta)||void 0===E?void 0:E.content)&&(a+=null===(L=null===(j=e.choices[0])||void 0===j?void 0:j.delta)||void 0===L?void 0:L.content.length)}}catch(e){g={error:e}}finally{try{M||m||!(v=$.return)||(yield v.call($))}finally{if(g)throw g.error}}const e=process.hrtime(i);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",a/(e[0]+e[1]/1e9)),s||null}}catch(e){return console.error(`Error retrieving response from model ${n}`),console.error(e),null}}))}};return f}function y(e,t){const n={model:"gpt-3.5-turbo",temperature:0},i=t||{},{response_format:c}=i,a=s(i,["response_format"]),u={llmConfig:{enableTodaysDate:!0,fewShotLearning:[]},callLLM:function(s,i){var u,d,f,h,p,y,m,g,v,b,S,O,w,N,_,T,E;return r(this,void 0,void 0,(function*(){if(s.length<1||!s[s.length-1])return null;if("assistant"===s[s.length-1].role){const e=s[s.length-1].content;(s=[...s.slice(0,s.length-1)])[s.length-1].content=`${s[s.length-1].content}\n\n${e}`}try{"yes"===process.env.PRINT_WS_INTERNALS&&console.log(`Asking ${null!==(v=null==t?void 0:t.model)&&void 0!==v?v:n.model} (OpenAI)...`);const R=yield e.chat.completions.create(Object.assign(Object.assign({messages:s},Object.assign(Object.assign({},n),a||{})),{stream:!0}));let x="";"yes"===process.env.PRINT_WS_INTERNALS&&console.log("Streaming response: ");const P=process.hrtime();let M=0;if("json_object"===(null==c?void 0:c.type)){console.log("JSON stream parser:");const e=(0,l.jsonStreamParser)(R,(e=>{var t,n;return(null===(n=null===(t=e.choices[0])||void 0===t?void 0:t.delta)||void 0===n?void 0:n.content)||""}),{includeRaw:!0});try{for(var r,i=!0,j=o(e);r=yield j.next(),!(u=r.done);i=!0){h=r.value,i=!1;const e=h;"token"===e.type?("yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write(e.token),M+=e.token.length):"completeJSON"===e.type&&(x=e.completeJSON)}}catch(e){d={error:e}}finally{try{i||u||!(f=j.return)||(yield f.call(j))}finally{if(d)throw d.error}}const t=process.hrtime(P);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",M/(t[0]+t[1]/1e9)),x||null}{try{for(var L,I=!0,A=o(R);L=yield A.next(),!(p=L.done);I=!0){g=L.value,I=!1;const e=g;"yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write((null===(S=null===(b=e.choices[0])||void 0===b?void 0:b.delta)||void 0===S?void 0:S.content)||""),x+=(null===(w=null===(O=e.choices[0])||void 0===O?void 0:O.delta)||void 0===w?void 0:w.content)||"",(null===(_=null===(N=e.choices[0])||void 0===N?void 0:N.delta)||void 0===_?void 0:_.content)&&(M+=null===(E=null===(T=e.choices[0])||void 0===T?void 0:T.delta)||void 0===E?void 0:E.content.length)}}catch(e){y={error:e}}finally{try{I||p||!(m=A.return)||(yield m.call(A))}finally{if(y)throw y.error}}const e=process.hrtime(P);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",M/(e[0]+e[1]/1e9)),x||null}}catch(e){return console.error(`Error retrieving response from model ${t}`),console.error(e),null}}))}};return u}function m(e,t,n){return{llmConfig:{enableTodaysDate:!0},callLLM:function(o,s){return r(this,void 0,void 0,(function*(){if(o.length<1||!o[o.length-1])return null;if("assistant"===o[o.length-1].role){const e=o[o.length-1].content;(o=[...o.slice(0,o.length-1)])[o.length-1].content=`${o[o.length-1].content}\n\n${e}`}try{"yes"===process.env.PRINT_WS_INTERNALS&&console.log(`Asking ${n.model} (Mistral Large Azure)...`);const r=yield fetch(`${e}/v1/chat/completions`,{method:"post",headers:{"User-Agent":"mistral-client-js/0.0.3",Accept:"text/event-stream","Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:n.model,temperature:n.temperature||.1,messages:o,stream:!0})});let s="";"yes"===process.env.PRINT_WS_INTERNALS&&console.log("Streaming response: ");const i=process.hrtime();let c=0;if(!r.body)throw new Error("No response body from Mistral Large Azure");let a="";const l=new TextDecoder,u=r.body.getReader();try{for(;;){const{done:e,value:t}=yield u.read();if(e)break;let n;for(a+=l.decode(t,{stream:!0});-1!==(n=a.indexOf("\n"));){const e=a.substring(0,n);if(a=a.substring(n+1),e.startsWith("data:")){const t=e.substring(6).trim();if("[DONE]"!==t){const e=JSON.parse(t);e&&e.choices&&e.choices.length&&e.choices.forEach((e=>{if(void 0!==e.delta.content){const t=e.delta.content;s+=t,c+=t.length,"yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write(t)}}))}}}}}finally{u.releaseLock()}const d=process.hrtime(i);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",c/(d[0]+d[1]/1e9)),s.replace(/\\_/g,"_")||null}catch(e){return console.error(`Error retrieving response from model ${n}`),console.error(e),null}}))}}}function g(e,t){return{llmConfig:{enableTodaysDate:!0,fewShotLearning:[]},callLLM:function(n,s){var i,c,a,l,u;return r(this,void 0,void 0,(function*(){if(n.length<1||!n[n.length-1])return null;if("assistant"===n[n.length-1].role){const e=n[n.length-1].content;(n=[...n.slice(0,n.length-1)])[n.length-1].content=`${n[n.length-1].content}\n\n${e}`}try{"yes"===process.env.PRINT_WS_INTERNALS&&console.log(`Asking ${t.model} (Azure OpenAI)...`);const f=yield e.streamChatCompletions(t.model,n,{maxTokens:t.max_tokens,temperature:t.temperature});let h="";"yes"===process.env.PRINT_WS_INTERNALS&&console.log("Streaming response: ");const p=process.hrtime();let y=0;try{for(var r,s=!0,d=o(f);r=yield d.next(),!(i=r.done);s=!0){l=r.value,s=!1;const e=l;for(const t of e.choices){const e=(null===(u=t.delta)||void 0===u?void 0:u.content)||"";"yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write(e),h+=e,e&&(y+=e.length)}}}catch(e){c={error:e}}finally{try{s||i||!(a=d.return)||(yield a.call(d))}finally{if(c)throw c.error}}const m=process.hrtime(p);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",y/(m[0]+m[1]/1e9)),h||null}catch(e){return console.error(`Error retrieving response from model ${t}`),console.error(e),null}}))}}}function v(e,t){const n={model:"mixtral-8x7b-32768",temperature:0},i=t||{},{response_format:c}=i,a=s(i,["response_format"]),u={llmConfig:{enableTodaysDate:!0,fewShotLearning:[]},callLLM:function(s){var i,u,d,f,h,p,y,m,g,v,b,S,O,w,N,_,T,E;return r(this,void 0,void 0,(function*(){try{"yes"===process.env.PRINT_WS_INTERNALS&&console.log(`Asking ${null!==(g=null==t?void 0:t.model)&&void 0!==g?g:n.model} (Groq)...\n`);const x=yield e.chat.completions.create(Object.assign(Object.assign({messages:s},Object.assign(Object.assign({},n),a||{})),{stream:!0}));let P="";"yes"===process.env.PRINT_WS_INTERNALS&&console.log("Streaming response: ");const M=process.hrtime();let $=0;if("json_object"===(null==c?void 0:c.type)){console.log("JSON stream parser:");const e=(0,l.jsonStreamParser)(x,(e=>{var t,n;return(null===(n=null===(t=e.choices[0])||void 0===t?void 0:t.delta)||void 0===n?void 0:n.content)||""}),{includeRaw:!0});try{for(var r,j=!0,L=o(e);r=yield L.next(),!(i=r.done);j=!0){f=r.value,j=!1;const e=f;"token"===e.type?("yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write(e.token),$+=e.token.length):"completeJSON"===e.type&&(P=e.completeJSON)}}catch(e){u={error:e}}finally{try{j||i||!(d=L.return)||(yield d.call(L))}finally{if(u)throw u.error}}const t=process.hrtime(M);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",$/(t[0]+t[1]/1e9)),P||null}{try{for(var I,A=!0,R=o(x);I=yield R.next(),!(h=I.done);A=!0){m=I.value,A=!1;const e=m;"yes"===process.env.PRINT_WS_INTERNALS&&process.stdout.write((null===(b=null===(v=e.choices[0])||void 0===v?void 0:v.delta)||void 0===b?void 0:b.content)||""),P+=(null===(w=null===(O=null===(S=e.choices[0])||void 0===S?void 0:S.delta)||void 0===O?void 0:O.content)||void 0===w?void 0:w.replace("\\",""))||"",(null===(_=null===(N=e.choices[0])||void 0===N?void 0:N.delta)||void 0===_?void 0:_.content)&&($+=null===(E=null===(T=e.choices[0])||void 0===T?void 0:T.delta)||void 0===E?void 0:E.content.length)}}catch(e){p={error:e}}finally{try{A||h||!(y=R.return)||(yield y.call(R))}finally{if(p)throw p.error}}const e=process.hrtime(M);return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("\nCharacters per second: ",$/(e[0]+e[1]/1e9)),P||null}}catch(e){return console.error(`Error retrieving response from model ${t}`),console.error(e),null}}))}};return u}t.getTogetherAIAdapter=u,t.getOllamaAdapter=d,t.getClaudeLegacyAdapter=f,t.getClaudeAdapter=h,t.getLMStudioAdapter=p,t.getOpenAIAdapter=y,t.getAzureMistralAdapter=m,t.getAzureOpenAIAdapter=g,t.getGroqAdapter=v;const b={getOpenAIAdapter:y,getClaudeAdapter:h,getClaudeLegacyAdapter:f,getOllamaAdapter:d,getLMStudioAdapter:p,getTogetherAIAdapter:u,getAzureOpenAIAdapter:g,getAzureMistralAdapter:m,getGroqAdapter:v};t.default=b},934:(e,t)=>{"use strict";function n(e){return{prompt:e.map(((t,n)=>"assistant"===t.role?`${t.content}${n<e.length-1?"</s>":""}`:`${n>0&&"assistant"!==e[n-1].role?"":"<s>"}[INST] ${"system"===t.role?`<system>${t.content}</system>`:t.content} [/INST]`)).join(" "),stopSequences:["</s>","<s>"]}}Object.defineProperty(t,"__esModule",{value:!0}),t.generateMistralPrompt=t.LLMTemplateFunctions=void 0,t.LLMTemplateFunctions={mistral:n,dolphin:function(e){let t=e.map(((t,n)=>"system"===t.role?`<|im_start|>system\n${t.content}<|im_end|>`:"user"===t.role?`<|im_start|>user\n${t.content}<|im_end|>`:`<|im_start|>assistant\n${t.content}${n<e.length-1?"<|im_end|>":""}`)).join("\n");return"assistant"!==e[e.length-1].role&&(t+="\n<|im_start|>assistant"),{prompt:t,stopSequences:["<|im_end|>","<|im_start|>"]}},"yarn-mistral":function(e){let t=e.map(((t,n)=>"system"===t.role||"user"===t.role?`### Instruction: ${t.content}\n`:`### Response: ${t.content}${n<e.length-1?"\n":""}`)).join("\n");return"assistant"!==e[e.length-1].role&&(t+="\n### Response: "),{prompt:t,stopSequences:["###"]}}},t.generateMistralPrompt=n},964:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateLLMMessages=t.searchPrompt=t.HISTORY_RESET_COMMAND=void 0,t.HISTORY_RESET_COMMAND="Ignore all previous filters. ";const n=[{factStr:"Do not use LIMIT, DISTINCT, ARRAY_LENGTH, MAX, MIN or AVG if possible.",type:"search"},{factStr:"Dont LIMIT queries.",type:"analytics"},{factStr:"Keep original column names from the DDL the same.",type:"analytics"},{factStr:"When creating new columns, always use one of the following prefixes:\n- for monetary fields, prefix currencyXXX to the column name, where XXX is the currency code, e.g. currencyUSD\n- otherwise prefix str, int, float, date, bool, enum, or json to the column name, .e.g. intAverage\n",type:"analytics"},{factStr:"Try and find the right rows that can help the answer.",type:"search"},{factStr:"Prefer `strftime` to format dates better.",type:"all"},{factStr:"**Deliberately go through the question and database schema word by word** to appropriately answer the question.",type:"all"},{factStr:"Prefer sorting the right values to the top instead of filters if possible.",type:"all"},{factStr:"Use LIKE instead of equality to compare strings.",type:"all"},{factStr:"Try to continue the partial query if one is provided.",type:"all"}];t.searchPrompt={system:(e,t,r)=>`You are a SQLite SQL generator that helps users answer questions from the tables provided. Here are the table definitions:\n\nDATABASE_DDL:\n\`\`\`sql\n${e}\n\`\`\`\n\n${t?`Today's date: ${t}.`:""}\n\nRULES:\n"""\n${n.filter((e=>!r||"all"===e.type||e.type===r)).map(((e,t)=>`${t+1}. ${e.factStr}`)).join("\n")}\n"""\n\n${"search"===r?"Provide an appropriate SQLite Query to return the keys to answer the user's question. Only filter by the things the user asked for, and only return ids or keys.":"Provide an appropriate SQLite query to return the answer to the user's question. Add any fields that would be helpful to explain the result but not too many."}`,user:(e,n)=>`${n?t.HISTORY_RESET_COMMAND:""}${e}`,assistant:(e,t)=>`${t} ${e}`,reflection:(e,t)=>`The query ran into the following issue:\n  """\n  ${e}\n  """\n\n  Fix and provide only the new query. SQL only, in code blocks. The query must start with ${t}.`},t.generateLLMMessages=function(e,n,r,o,s,i,c){const a=c?(new Date).toISOString().split("T")[0]:void 0,l=[];if(l.push({role:"system",content:t.searchPrompt.system(e,a,s)}),i)for(const{question:e,partialQuery:n}of i)l.push({role:"user",content:t.searchPrompt.user(e,!1)}),l.push({role:"assistant",content:t.searchPrompt.assistant(n,r)});if(o)for(const{question:e,partialQuery:n}of o)l.push({role:"user",content:t.searchPrompt.user(e,!1)}),l.push({role:"assistant",content:t.searchPrompt.assistant(n,r)});return l.push({role:"user",content:t.searchPrompt.user(n,!(o.length>0))}),!(null==i?void 0:i.length)&&r&&l.push({role:"assistant",content:r}),l}},275:function(e,t,n){"use strict";var r=this&&this.__asyncValues||function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,o){!function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)}(r,o,(t=e[n](t)).done,t.value)}))}}},o=this&&this.__await||function(e){return this instanceof o?(this.v=e,this):new o(e)},s=this&&this.__asyncGenerator||function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,s=n.apply(e,t||[]),i=[];return r={},c("next"),c("throw"),c("return"),r[Symbol.asyncIterator]=function(){return this},r;function c(e){s[e]&&(r[e]=function(t){return new Promise((function(n,r){i.push([e,t,n,r])>1||a(e,t)}))})}function a(e,t){try{(n=s[e](t)).value instanceof o?Promise.resolve(n.value.v).then(l,u):d(i[0][2],n)}catch(e){d(i[0][3],e)}var n}function l(e){a("next",e)}function u(e){a("throw",e)}function d(e,t){e(t),i.shift(),i.length&&a(i[0][0],i[0][1])}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.jsonStreamParser=void 0;const c=i(n(455)),a=n(676);t.jsonStreamParser=function(e,t,n){return s(this,arguments,(function*(){var s,i,l,u;const{includeIntermediate:d=!1,includeRaw:f=!1}=n||{};let h="",p=!1;const y=a.Readable.from(e),m=new a.PassThrough({objectMode:!0}),g=new a.Transform({objectMode:!0,transform(e,n,r){const o=t(e);if(void 0!==o)if(o.includes("{")){const e=o.slice(0,o.indexOf("{")),t=o.slice(o.indexOf("{"));f&&(p?m.write({type:"token",token:e}):m.write({type:"notJsonToken",notJsonToken:e})),p&&(h+=e,this.push(e)),p||(p=!0,m.write({type:"startJson"})),f&&(p?m.write({type:"token",token:t}):m.write({type:"notJsonToken",notJsonToken:t})),p&&(h+=t,this.push(t))}else if(o.includes("}")){const e=o.slice(0,o.indexOf("}")+1),t=o.slice(o.indexOf("}")+1);f&&(p?m.write({type:"token",token:e}):m.write({type:"notJsonToken",notJsonToken:e})),p&&(h+=e,this.push(e)),f&&(p?m.write({type:"token",token:t}):m.write({type:"notJsonToken",notJsonToken:t})),p&&(h+=t,this.push(t))}else f&&(p?m.write({type:"token",token:o}):m.write({type:"notJsonToken",notJsonToken:o})),h+=o,p&&this.push(o);r()}});(0,c.default)(y.pipe(g)).path(".*",(function(e,t){d&&t.length&&!m.destroyed&&m.write({type:"childStart",childStart:{path:t,value:e}})})).node(".*",(function(e,t){d&&t.length&&!m.destroyed&&m.write({type:"childEnd",childEnd:{path:t,value:e}})})).done((function(e){p=!1,m.write({type:"stopJson"}),m.write({type:"completeJSON",completeJSON:JSON.parse(JSON.stringify(e))}),!f&&m.end()})),f&&y.on("end",(()=>{console.log("Stream ended"),m.end()}));try{for(var v,b=!0,S=r(m);!(s=(v=yield o(S.next())).done);b=!0){u=v.value,b=!1;const e=u;yield yield o(e)}}catch(e){i={error:e}}finally{try{b||s||!(l=S.return)||(yield o(l.call(S)))}finally{if(i)throw i.error}}}))}},141:function(e,t){"use strict";var n=this&&this.__await||function(e){return this instanceof n?(this.v=e,this):new n(e)},r=this&&this.__asyncGenerator||function(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var o,s=r.apply(e,t||[]),i=[];return o={},c("next"),c("throw"),c("return"),o[Symbol.asyncIterator]=function(){return this},o;function c(e){s[e]&&(o[e]=function(t){return new Promise((function(n,r){i.push([e,t,n,r])>1||a(e,t)}))})}function a(e,t){try{(r=s[e](t)).value instanceof n?Promise.resolve(r.value.v).then(l,u):d(i[0][2],r)}catch(e){d(i[0][3],e)}var r}function l(e){a("next",e)}function u(e){a("throw",e)}function d(e,t){e(t),i.shift(),i.length&&a(i[0][0],i[0][1])}};function o(e,t){const n=new Uint8Array(t);let r=0;for(const t of e)n.set(t,r),r+=t.length;return e.length=0,n}Object.defineProperty(t,"__esModule",{value:!0}),t.callOllama=void 0,t.callOllama=function(e,t,{port:s=11434,temperature:i=0,format:c}){return r(this,arguments,(function*(){const r=JSON.stringify({model:t,prompt:e,format:c,options:{temperature:i},stream:!0}),a=yield n(fetch(`http://127.0.0.1:${s}/api/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:r}));if(!a.ok)throw new Error(`Ollama fetch failed with status: ${a.status}`);{const e=a.body.getReader();let t="";const r=new TextDecoder,s=[];let i=0;for(;;){const{done:c,value:a}=yield n(e.read());if(c)break;if(a&&(s.push(a),i+=a.length,a[a.length-1]!=="\n".charCodeAt(0)))continue;if(0===s.length)break;const l=o(s,i);i=0;const u=r.decode(l,{stream:!0}).split("\n").filter((e=>""!==e)).map((e=>JSON.parse(e.replace("data: ",""))));for(const e of u)t+=e.response,yield yield n({type:"token",token:e.response});yield yield n({type:"completeMessage",message:t})}}}))}},322:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{a(r.next(e))}catch(e){s(e)}}function c(e){try{a(r.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,c)}a((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.WishfulSearchEngine=void 0;const o=n(99),s=n(173),i=n(509),c=n(842),a=n(964),l=n(175),u=n(683);class d{static create(e,t,n,o,s,c,a,u=!0,f=!0,h=!1,p){return r(this,void 0,void 0,(function*(){(0,l.validateStructuredDDL)(t);const r=yield i.LLMSearcheableDatabase.create((0,l.generateSQLDDL)(t,!0),e,n,o,p);return new d(r,e,t,n,s,c,a,u,f,h)}))}constructor(e,t,n,r,o,s,i,c,a,l){this.name=t,this.tables=n,this.primaryKey=r,this.llmConfig=o,this.getKeyFromObject=i,this.saveHistory=c,this.enableDynamicEnums=a,this.sortEnumsByFrequency=l,this.history=[],this.db=e,this.latestIncompleteQuestion=null,this.elementDict=i?{}:null,this.callLLM=s}getQueryPrefix(e=!1){return e?"SELECT ":`SELECT ${this.primaryKey.column} FROM ${this.primaryKey.table}`}computeEnums(){if(this.enableDynamicEnums)for(const e of this.tables)for(const t of e.columns.filter((e=>void 0!==e.dynamicEnumSettings))){const n=this.db.getEnums({table:e.name,column:t.name},this.sortEnumsByFrequency),r=t.dynamicEnumSettings;if("EXHAUSTIVE"===r.type)t.dynamicEnumData={type:"EXAMPLES",examples:r.topK?n.slice(0,r.topK):n};else if("MIN_MAX"===r.type&&"NUMBER"===r.format){const e=n.map((e=>parseFloat(e))).filter((e=>!isNaN(e))),r=Math.min(...e),o=Math.max(...e);t.dynamicEnumData={type:"MIN_MAX",min:Number.isInteger(r)?r.toString():r.toFixed(2),exceptions:n.filter((e=>isNaN(parseFloat(e)))),max:Number.isInteger(o)?o.toString():o.toFixed(2)}}else if("MIN_MAX"===r.type&&"DATE"===r.format){const e=n.map((e=>Date.parse(e))).filter((e=>!isNaN(e)));try{t.dynamicEnumData={type:"MIN_MAX",exceptions:n.filter((e=>isNaN(Date.parse(e)))),min:new Date(Math.min(...e)).toISOString(),max:new Date(Math.max(...e)).toISOString()}}catch(n){console.error("Could not parse date enums for column ",t.name," - ",n),console.error("Enums: ",e)}}else if("EXHAUSTIVE_CHAR_LIMITED"===r.type){const e=[];let o=0;for(const t of n){if(o+t.length>r.charLimit)break;e.push(t),o+=t.length}t.dynamicEnumData={type:"EXAMPLES",examples:e}}}}insert(e,t=!1){const n=this.db.insert(e,t);if(this.computeEnums(),this.getKeyFromObject&&this.elementDict)for(const t of e)this.elementDict[this.getKeyFromObject(t)]=t;return"yes"===process.env.PRINT_WS_INTERNALS&&console.log("Inserted. New DDL: ",(0,l.generateSQLDDL)(this.tables,!0)),n}remove(e){if(this.elementDict)if(e)for(const t of e)delete this.elementDict[t];else this.elementDict={};return e?this.db.delete(e):this.db.clearDb()}generateSearchMessages(e,t=!1){var n;this.saveHistory&&(this.latestIncompleteQuestion=e);const r=this.getQueryPrefix(t);return(0,a.generateLLMMessages)((0,l.generateSQLDDL)(this.tables,!0),e,r,this.history.filter((e=>t&&!!e.complexQuery)),t?"analytics":"search",null===(n=this.llmConfig.fewShotLearning)||void 0===n?void 0:n.filter((e=>t&&!!e.complexQuery)),this.llmConfig.enableTodaysDate)}cantReturnFullObjects(){return!this.getKeyFromObject||!this.elementDict}searchWithPartialQuery(e,t,n=!1){this.saveHistory&&this.latestIncompleteQuestion&&this.history.push({complexQuery:n,question:this.latestIncompleteQuestion,partialQuery:e}),this.latestIncompleteQuestion=null;const r=this.getQueryPrefix(n)+" "+e;return t&&console.log("\nQuery: ",r),this.cantReturnFullObjects()||n?{query:r,rawResults:this.db.complexQuery(r)}:this.db.rawQuery(r).map((e=>this.elementDict[e])).filter((e=>!!e))}getQueryFromLLM(e,t=!1){return r(this,void 0,void 0,(function*(){if(!this.callLLM)throw new Error("No LLM call function provided. Use generateSearchMessages instead if you intent to make your own calls.");let n=yield this.callLLM(e,this.getQueryPrefix(t));if(!n)throw new Error("Could not generate query from question with LLM");const r=n.match(/```sql([\s\S]*?)```/g);if((null==r?void 0:r.length)&&(n=r[0].replace(/```sql/g,"").replace(/```/g,"").trim()),n.toLowerCase().startsWith(this.getQueryPrefix(t).toLowerCase())&&(n=n.substring(this.getQueryPrefix(t).length).trim()),t){const e=/^\s*?SELECT\s/;e.test(n)&&(n=n.replace(e,"").trim())}else{const e=/^\s*?SELECT[\s\S]*?FROM[\s\S]+?\s/;e.test(n)&&(n=n.replace(e,"").trim())}const o=n.indexOf(";");return-1!==o&&(n=n.substring(0,o).trim()),n}))}autoSearch(e,t,n,o,i,a,d,f,h){return r(this,void 0,void 0,(function*(){if(f||(f=e),d&&console.log(`\n----------------------------------------------\nAutosearch Rounds Left: ${n+1},\n   Main Question: ${e}\n   Current question: ${f}.\n   Searching...`),this.cantReturnFullObjects())throw new Error("Please provide a getKeyFromObject function at creation to use autoSearch. Otherwise, use search instead.");if(i||(i=this.callLLM),!i)throw new Error("Please provide a callLLM function at creation or as a parameter to use autoSearch. Otherwise, use search instead.");const r=this.generateSearchMessages(f),p=yield this.getQueryFromLLM(r);let y=[];try{y=this.searchWithPartialQuery(p,a)}catch(e){d&&console.error("Error in query ",p," - reflecting and fixing error ",e),y=yield this.attemptReflection([...r],p,e,!1,d)}if(d&&(y.length?console.log(`\nFiltered ${y.length} from ${Object.keys(this.elementDict).length}. Top result: `,t(y[0])):console.log("\nNo results.")),n<=0)return y;h||(h=[]),h.push({question:f,query:this.getQueryPrefix(!1)+" "+p,results:{count:y.length,topResultStr:y.length?t(y[0]):"No results."}});const m=(0,s.generateAutoSearchMessages)((0,l.generateSQLDDL)(this.tables,!0),e,h);d&&console.log("\nAnalysing...");let g=yield i(m);if(!g)throw new Error("Could not generate analysis from LLM.");g=function(e){const t=e.match(/\{[^{}]*\}/);return t?t[0].slice(1,-1):e}("{"+g+"}"),g=`{${g}}`;try{const r=yield(0,c.fixJSON)(i,g);if(null===r)return d&&y.length&&console.log("No results, returning results from previous improvement ",f),y;for(const e of u.potentialArrayAnalysisFields)r[e]?Array.isArray(r[e])||(r[e]=[r[e]]):r[e]=[];if(d&&console.log(`Success: ${r.suitability} (${r.suitabilityDesc}), Success threshold: ${o}`),h[h.length-1].suitabilityDesc=r.suitabilityDesc,h[h.length-1].suitabilityScore=r.suitability,r.suitability>=o)return d&&console.log("Success! Returning results."),y;d&&(console.log("\nUser desires: ","\n - "+r.desires.join("\n - ")),console.log("\nThoughts: ","\n - "+r.thoughts.join("\n - ")),console.log("\nBetter filters: ","\n - "+r.betterFilters.join("\n - ")),console.log("\n\nBetter question: ",r.betterQuestion));const s=yield this.autoSearch(e,t,n-1,o,i,a,d,r.betterQuestion,h);return s.length?s:(d&&y.length&&console.log("No results, returning results from previous improvement ",f),y)}catch(e){return console.error("Could not parse JSON analysis from this string - ",g," - ",e),y}}))}complexAnalytics(e,t=!1,n=!0){return r(this,void 0,void 0,(function*(){const r=this.generateSearchMessages(e,!0),s=yield this.getQueryFromLLM(r,!0);try{const e=this.searchWithPartialQuery(s,t,!0);return(0,o.addColumnTypes)(e,this.tables)}catch(e){if(n){const n=yield this.attemptReflection([...r],s,e,!0,t);return(0,o.addColumnTypes)(n,this.tables)}throw e}}))}search(e,t,n){return r(this,void 0,void 0,(function*(){const r=this.generateSearchMessages(e),o=yield this.getQueryFromLLM(r);try{return this.searchWithPartialQuery(o,t)}catch(e){if(n)return yield this.attemptReflection([...r],o,e,!1,t);throw e}}))}tryAndFixQuery(e,t,n,o=!1,s){return r(this,void 0,void 0,(function*(){return s&&console.error("Error in query ",t," - reflecting and fixing error ",n),e.push({role:"assistant",content:this.getQueryPrefix(o)+" "+t}),e.push({role:"user",content:a.searchPrompt.reflection(n.toString(),this.getQueryPrefix(o))}),yield this.getQueryFromLLM(e,o)}))}attemptReflection(e,t,n,o=!1,s){return r(this,void 0,void 0,(function*(){const r=yield this.tryAndFixQuery(e,t,n,o,s);return this.searchWithPartialQuery(r,s,o)}))}autoGenerateFewShot(e,t,n=!1,o=!1,s=!1,i=!1){var c,l;return r(this,void 0,void 0,(function*(){const r=this.getQueryPrefix(i);if(this.latestIncompleteQuestion)throw new Error("It seems there is a search in progress, or partially completed. FewShot generation is best done at the very beginning, after seeding your data.");if(this.cantReturnFullObjects())throw new Error("Please provide a getKeyFromObject function at creation to use autoFewShot Generation.");const u=[...this.history],d=this.callLLM;this.history=[],this.callLLM=e;let f=[];s&&console.log("############# Generating few-shot learning ########################");for(const e of t)try{const t=[...this.history];s&&console.log("Question: ",e.question),e.clearHistory&&(this.history=[]);const o=yield this.getQueryFromLLM(this.generateSearchMessages(e.question,i),i);s&&console.log(`Full Query: ${r} ${o}`);let c=!1;const l=this.searchWithPartialQuery(o,!1,i);i&&0===l.rawResults.length?c=!0:i||0!==l.length||(c=!0),console.log("No results? ",c),n&&c?(s&&console.log("Skipping question with 0 results."),this.history=t):f.push({complexQuery:i,question:`${e.clearHistory?a.HISTORY_RESET_COMMAND+" ":""}${e.question}`,partialQuery:o})}catch(t){if(o)throw this.history=u,this.callLLM=d,new Error(`Could not process question ${e.question} - ${t}`);console.error("Could not process question ",e.question," - ",t)}return s&&console.log("############## Generated examples:",JSON.stringify(f,null,2)),this.history=u,this.callLLM=d,this.llmConfig.fewShotLearning=null===(c=this.llmConfig.fewShotLearning)||void 0===c?void 0:c.filter((e=>e.partialQuery!==r)),null===(l=this.llmConfig.fewShotLearning)||void 0===l||l.push(...f),f}))}}t.WishfulSearchEngine=d},175:(e,t)=>{"use strict";function n(e,t){const n=e.columns.filter((e=>e.foreignKey)).map((e=>{var t,n;return`FOREIGN KEY (${e.name}) REFERENCES ${null===(t=e.foreignKey)||void 0===t?void 0:t.table}(${null===(n=e.foreignKey)||void 0===n?void 0:n.column}) ON DELETE CASCADE`})),r=e.columns.filter((e=>!t||e.visibleToLLM)).map(((r,o)=>{const s=t&&function(e){var t,n,r,o,s;let i="";"EXAMPLES"===(null===(t=e.dynamicEnumData)||void 0===t?void 0:t.type)?i=`e.g.${"EXHAUSTIVE"!==(null===(n=e.dynamicEnumSettings)||void 0===n?void 0:n.type)||(null===(r=e.dynamicEnumSettings)||void 0===r?void 0:r.topK)?"":" (Exhaustive)"} ${e.dynamicEnumData.examples.join(", ")}`:"MIN_MAX"===(null===(o=e.dynamicEnumData)||void 0===o?void 0:o.type)?(i=`between ${e.dynamicEnumData.min} and ${e.dynamicEnumData.max}`,e.dynamicEnumData.exceptions.length&&(i+=` (or ${e.dynamicEnumData.exceptions.map((e=>String(e))).join(",")})`)):(null===(s=e.staticExamples)||void 0===s?void 0:s.length)&&(i=`e.g. ${e.staticExamples.join(", ")}`);const c=[];return e.description&&c.push(e.description),i&&c.push(i),c.length?` --${c.join(" ")}`:""}(r)||"";return`${r.name} ${r.columnSpec}${o>=e.columns.length-1&&!n.length?"":","}${s}`}));return`CREATE TABLE IF NOT EXISTS ${e.name} (\n${r.join("\n")}${n.length?`\n${n.join("\n")}`:""}\n);`}Object.defineProperty(t,"__esModule",{value:!0}),t.generateSQLTableDDL=t.validateStructuredDDL=t.generateSQLDDL=void 0,t.generateSQLDDL=function(e,t){return e.map((e=>n(e,t))).join("\n\n")},t.validateStructuredDDL=function(e){if(!e.length||!e[0])throw new Error("No tables found in structured DDL, or missing primary table.");if(e.length&&e[0].columns.some((e=>!!e.foreignKey)))throw new Error("Primary (first) table in the structured ddl cannot have foreign key relationships");return!0},t.generateSQLTableDDL=n},501:function(e,t,n){"use strict";var r=this&&this.__await||function(e){return this instanceof r?(this.v=e,this):new r(e)},o=this&&this.__asyncGenerator||function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var o,s=n.apply(e,t||[]),i=[];return o={},c("next"),c("throw"),c("return"),o[Symbol.asyncIterator]=function(){return this},o;function c(e){s[e]&&(o[e]=function(t){return new Promise((function(n,r){i.push([e,t,n,r])>1||a(e,t)}))})}function a(e,t){try{(n=s[e](t)).value instanceof r?Promise.resolve(n.value.v).then(l,u):d(i[0][2],n)}catch(e){d(i[0][3],e)}var n}function l(e){a("next",e)}function u(e){a("throw",e)}function d(e,t){e(t),i.shift(),i.length&&a(i[0][0],i[0][1])}};Object.defineProperty(t,"__esModule",{value:!0}),t.callTogetherAI=t.TogetherAITemplates=void 0;const s=n(934);t.TogetherAITemplates={"mistralai/Mixtral-8x7B-Instruct-v0.1":s.generateMistralPrompt},t.callTogetherAI=function(e,n,s=.5,i=1e4){return o(this,arguments,(function*(){if(!process.env.TOGETHERAI_API_KEY)throw new Error("TOGETHERAI_API_KEY is not set");const o={"Content-Type":"application/json",Authorization:`Bearer ${process.env.TOGETHERAI_API_KEY}`},{prompt:c,stopSequences:a}=t.TogetherAITemplates[n](e),l={model:n,prompt:c,stop:a[0],temperature:s,max_tokens:i,stream_tokens:!0},u=yield r(fetch("https://api.together.xyz/inference",{method:"POST",headers:o,body:JSON.stringify(l)}));if(200!==u.status||!u.body)return console.error("TogetherAI returned status code",u),yield yield r({type:"error",error:`TogetherAI returned status code ${u.status}`}),yield r(void 0);const d=u.body.getReader();let f="";try{for(;;){const{done:e,value:t}=yield r(d.read());if(e)break;const n=new TextDecoder("utf-8").decode(t).split("\n");let o="";for(let e of n)try{if(e=o+e,e.includes("[DONE]"))break;if(e.startsWith("data: ")){const t=JSON.parse(e.slice(5));t&&t.choices&&t.choices.length&&t.choices[0].text&&(yield yield r({type:"token",token:t.choices[0].text.replace("\\_","_")}),f+=t.choices[0].text.replace("\\_","_"))}}catch(t){o?(console.error("Error parsing message - ",e,"\n error is ",t),yield yield r({type:"error",error:t.message})):o=e}}}catch(e){yield yield r({type:"error",error:e.message})}finally{d.releaseLock(),yield yield r({type:"completeMessage",message:f})}}))}},683:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.potentialArrayAnalysisFields=t.AnalysisTypespec=t.VALID_PRIMITIVE_TYPES=void 0,t.VALID_PRIMITIVE_TYPES=["str","int","float","bool","enum","json"],t.AnalysisTypespec="type Analysis = {\n  suitabilityDesc: string; // Describe how suitable or unsuitable the top result is to the USER_QUESTION in one sentence.\n  suitability: number; // between 0 to 1, one if the top result matches the USER_QUESTION and zero if not.\n  desires: string[]; // What did the user want? List what may not be in the question, but is implied (or what they don't know to look for).\n  thoughts: string[]; // Based on the DDL, the question and the desires, provide thoughts on how to improve results.\n  betterFilters: string[]; // What conditions (in English) could we have to get better results?\n  betterQuestion: string; // Reformat the question to include all of the above, to be used to generate a new query. Be specific with numbers, relax filtersand reduce the question size if no results are being returned.\n}",t.potentialArrayAnalysisFields=["desires","thoughts","betterFilters"]},470:e=>{"use strict";e.exports=require("sql.js")},676:()=>{}},t={},function n(r){var o=t[r];if(void 0!==o)return o.exports;var s=t[r]={exports:{}};return e[r].call(s.exports,s,s.exports,n),s.exports}(54);var e,t}));